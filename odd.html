<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Odd Semester SGPA Predictor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="predictor.css">
</head>

<body>

<div class="page">

  <div class="top-bar">
    <h1>Odd Semester SGPA Predictor</h1>
    <button onclick="logout()">Logout</button>
  </div>

  <div class="info" id="userInfo"></div>

  <div id="form" class="card"></div>

  <div class="action-bar">
    <button onclick="predictGrades()">Get Result</button>
    <button onclick="clearInputs()">Clear</button>
  </div>

  <div id="result" class="card"></div>

<!-- âš ï¸ Invalid Marks Warning -->
<div id="warning" style="display:none; text-align:center; margin-top:20px;">
  <img src="idiot_warning.png" style="max-width:90%; border-radius:12px;">
</div>

<script>
/* ========= AUTH ========= */
const name = localStorage.getItem("name");
const semester = localStorage.getItem("semester");

if (!name || !["3","5","7"].includes(semester)) {
  window.location.href = "under_construction.html";
}

document.getElementById("userInfo").innerText =
  `ðŸ‘¤ ${name} | Semester: ${semester}`;

/* ========= SUBJECT DATA ========= */
const semesterSubjects = {

  /* ===== SEM 3 ===== */
  "3": [
    { name: "Transform Techniques & Linear Programming", credits: 3, isHalf: false },
    { name: "Signal Processing", credits: 3, isHalf: false },
    { name: "Analog & Digital Electronic Circuits", credits: 3, isHalf: false },
    { name: "Human Anatomy & Physiology", credits: 3, isHalf: false },
    { name: "Object Oriented Programming", credits: 3, isHalf: false },

    { name: "Universal Human Values", credits: 2, isHalf: false },

    { name: "ADEC Lab", credits: 1, isHalf: true },
    { name: "OOP Lab", credits: 1, isHalf: true },
    { name: "AEC â€“ Sensor Technology", credits: 1, isHalf: true }
  ],

  /* ===== SEM 5 ===== */
  "5": [
    { name: "Medical Physics", credits: 4, isHalf: false },

    { name: "Digital Image Processing", credits: 3, isHalf: false },
    { name: "Biomedical Instrumentation", credits: 3, isHalf: false },
    { name: "Diagnostic & Therapeutic Equipment", credits: 3, isHalf: false },
    { name: "Java / Python Programming", credits: 3, isHalf: false },
    { name: "Research Methodology & IPR", credits: 3, isHalf: false },

    { name: "Medical Physics Lab", credits: 1, isHalf: true },
    { name: "Biomedical Instrumentation Lab", credits: 1, isHalf: true },
    { name: "Safety of Biomedical Equipment", credits: 1, isHalf: true }
  ],

  /* ===== SEM 7 ===== */
  "7": [
    { name: "Neural Networks and Deep Learning", credits: 4, isHalf: false },

    { name: "Medical Imaging Techniques", credits: 3, isHalf: false },
    { name: "Wearable Devices", credits: 3, isHalf: false },
    { name: "Open Elective", credits: 3, isHalf: false },
    { name: "Skill Enhancement Lab", credits: 3, isHalf: true },

    { name: "AI in Healthcare Lab", credits: 1, isHalf: true }
  ]
};

const subjects = semesterSubjects[semester];

/* ========= GRADING ========= */
const grades = [10,9,8,7,6,5,0];
const gradeLabels = {10:"O",9:"A+",8:"A",7:"B+",6:"B",5:"C",0:"F"};
const selectedGrades = {};

/* ========= BUILD FORM ========= */
const form = document.getElementById("form");
subjects.forEach((sub, i) => {
  const div = document.createElement("div");
  div.className = "subject-group";
  div.innerHTML = `
    <label>${sub.name} (${sub.credits} Credits) â€“ Internal Marks:</label>
    <input type="number" id="sub${i}" min="0" max="50">
  `;
  form.appendChild(div);
});

/* ========= LOGIC ========= */
function calculateRequiredMarks(internal, grade, isHalf) {
  const lower = {10:90,9:80,8:70,7:60,6:50,5:40}[grade];
  if (!lower) return -1;
  const req = isHalf ? (lower - internal) : 2 * (lower - internal);
  const max = isHalf ? 50 : 100;
  return (req < 0 || req > max) ? -1 : req;
}

function predictGrades() {
  document.getElementById("result").innerHTML = "";
  Object.keys(selectedGrades).forEach(k => delete selectedGrades[k]);

  // ðŸ”¥ HIDE WARNING FIRST
  document.getElementById("warning").style.display = "none";

  // ðŸ”¥ INVALID INTERNAL MARKS CHECK
  for (let i = 0; i < subjects.length; i++) {
    const val = parseFloat(document.getElementById(`sub${i}`).value);
    if (!isNaN(val) && (val > 50 || val < 10)) {
      document.getElementById("warning").style.display = "block";
      return; // â›” STOP FUNCTION HERE
    }
  }

  let html = "";

  subjects.forEach((sub, i) => {
  const internal = parseFloat(document.getElementById(`sub${i}`).value);
  if (isNaN(internal)) return;

  html += `<h3>${sub.name}</h3>`;
  html += `<table class="output-table"><tr>`;

  grades.forEach(g => {
    html += `<th>${gradeLabels[g]}</th>`;
  });

  html += `</tr><tr>`;

  grades.forEach(g => {
    const r = calculateRequiredMarks(internal, g, sub.isHalf);
    const cls = r === -1
      ? "not-possible"
      : (r <= (sub.isHalf ? 45 : 86) ? "realistic" : "possible");

    html += `<td class="${cls}">${r === -1 ? "-" : r.toFixed(1)}</td>`;
  });

  html += `</tr></table>`;

  let def = 0;
  for (let g of grades) {
    const r = calculateRequiredMarks(internal, g, sub.isHalf);
    if (r !== -1 && r <= (sub.isHalf ? 45 : 86)) {
      def = g;
      break;
    }
  }

  selectedGrades[sub.name] = def;

  html += `<p><strong>Select Expected Grade:</strong><br>`;
  grades.forEach(g => {
    html += `
      <label>
        <input type="radio" name="g${i}" ${g === def ? "checked" : ""}
        onchange="updateSelectedGrade('${sub.name}', ${g})">
        ${gradeLabels[g]}
      </label>
    `;
  });
  html += `</p>`;
});

  document.getElementById("result").innerHTML = html;
  updateSGPA();
}

function updateSelectedGrade(sub, g) {
  selectedGrades[sub] = g;
  updateSGPA();
}

function updateSGPA() {
  let tc = 0, tp = 0;
  subjects.forEach(s => {
    if (selectedGrades[s.name] !== undefined) {
      tc += s.credits;
      tp += selectedGrades[s.name] * s.credits;
    }
  });

  const sgpa = (tp / tc).toFixed(2);
  document.getElementById("result")
    .insertAdjacentHTML("beforeend", `<h2>ðŸŽ¯ SGPA: ${sgpa}</h2>`);

  saveResult(sgpa);
}

/* ========= BACKEND ========= */
function saveResult(sgpa) {
  fetch("https://sgpa-backend-m676.onrender.com/save-history", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, semester, result: sgpa, grades: selectedGrades })
  });
}

/* ========= UTIL ========= */
function clearInputs() {
  subjects.forEach((_, i) => document.getElementById(`sub${i}`).value = "");
  document.getElementById("result").innerHTML = "";
}

function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}
</script>

</body>
</html>
