<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Odd Semester SGPA Predictor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="predictor.css">
</head>

<body>
<div class="page">

  <div class="top-bar">
    <h1 id="title">Odd Semester SGPA Predictor</h1>
    <button onclick="logout()">Logout</button>
  </div>

  <div class="info" id="userInfo"></div>
  <div id="form" class="card"></div>

  <div class="action-bar">
    <button onclick="predictGrades()">Get Result</button>
    <button onclick="clearInputs()">Clear</button>
  </div>

  <div id="result" class="card"></div>

  <!-- Warning -->
  <div id="warning" style="display:none;text-align:center;margin-top:15px;">
    <img src="idiot_warning.png" style="max-width:90%;border-radius:10px;">
  </div>

</div>

<script>
/* ===== AUTH ===== */
const name = sessionStorage.getItem("name");
const semester = sessionStorage.getItem("semester");
const usn = sessionStorage.getItem("usn");

if (!name || !["1","3","5","7"].includes(semester)) {
  window.location.href = "index.html";
}

document.getElementById("userInfo").innerText =
`ðŸ‘¤ ${name} | Semester: ${semester}`;

/* ===== SUBJECT DATA ===== */
const semesterSubjects = {

  /* ===== 1st SEM : CHEMISTRY CYCLE ===== */
  "1": [
    { name:"Mathematics", credits:4, isHalf:false },
    { name:"Engineering Chemistry", credits:3, isHalf:false },
    { name:"Basic Electrical", credits:3, isHalf:false },
    { name:"Engineering Drawing", credits:3, isHalf:false },
    { name:"Chemistry Lab", credits:1, isHalf:true },
    { name:"Workshop", credits:1, isHalf:true },
    { name:"AEC", credits:1, isHalf:true }
  ],

  /* ===== SEM 3 ===== */
  "3": [
    { name:"Transform Techniques", credits:4, isHalf:false },
    { name:"Signal Processing", credits:3, isHalf:false },
    { name:"Analog & Digital Circuits", credits:3, isHalf:false },
    { name:"Human Physiology", credits:3, isHalf:false },
    { name:"OOP", credits:3, isHalf:false },
    { name:"UHV", credits:2, isHalf:true },
    { name:"ADEC Lab", credits:1, isHalf:true },
    { name:"OOP Lab", credits:1, isHalf:true },
    { name:"AEC", credits:1, isHalf:true }
  ],

  /* ===== SEM 5 ===== */
  "5": [
    { name:"Medical Physics", credits:4, isHalf:false },
    { name:"Digital Image Processing", credits:3, isHalf:false },
    { name:"Biomedical Instrumentation", credits:3, isHalf:false },
    { name:"Diagnostic Equipment", credits:3, isHalf:false },
    { name:"Java / Python", credits:3, isHalf:false },
    { name:"RMIPR", credits:3, isHalf:false },
    { name:"Medical Physics Lab", credits:1, isHalf:true },
    { name:"BMI Lab", credits:1, isHalf:true },
    { name:"AEC", credits:1, isHalf:true }
  ],

  /* ===== SEM 7 ===== */
  "7": [
    { name:"Neural Networks & DL", credits:4, isHalf:false },
    { name:"Medical Imaging", credits:3, isHalf:false },
    { name:"Wearable Devices", credits:3, isHalf:false },
    { name:"Open Elective", credits:3, isHalf:false },
    { name:"Skill Lab", credits:2, isHalf:true },
    { name:"AI in Healthcare Lab", credits:1, isHalf:true }
  ]
};

const subjects = semesterSubjects[semester];

/* ===== GRADING ===== */
const grades=[10,9,8,7,6,5,0];
const gradeLabels={10:"O",9:"A+",8:"A",7:"B+",6:"B",5:"C",0:"F"};
const selectedGrades={};

/* ===== BUILD FORM ===== */
const form=document.getElementById("form");
subjects.forEach((sub,i)=>{
  const div=document.createElement("div");
  div.className="subject-group";
  div.innerHTML=`
   <label>${sub.name} (${sub.credits} cr) - Internal Marks:</label>
   <input type="text" id="sub${i}">
  `;
  form.appendChild(div);
});

/* ===== CORE LOGIC ===== */
function calculateRequiredMarks(internal,grade,isHalf){
  const lower={10:90,9:80,8:70,7:60,6:50,5:40}[grade];
  if(!lower) return -1;
  const req=isHalf?(lower-internal):2*(lower-internal);
  const max=isHalf?50:100;
  return (req<0||req>max)?-1:req;
}

function predictGrades(){

 document.getElementById("result").innerHTML="";
 document.getElementById("warning").style.display="none";
 Object.keys(selectedGrades).forEach(k=>delete selectedGrades[k]);

 // validation
 for(let i=0;i<subjects.length;i++){
   const raw=document.getElementById(`sub${i}`).value.trim();
   if(raw==="") continue;
   if(!/^\d+(\.\d+)?$/.test(raw)){
     document.getElementById("warning").style.display="block"; return;
   }
   const v=parseFloat(raw);
   if(v<0||v>50){
     document.getElementById("warning").style.display="block"; return;
   }
 }

 let html="";

 subjects.forEach((sub,i)=>{
   const internal=parseFloat(document.getElementById(`sub${i}`).value);
   if(isNaN(internal)) return;

   html+=`<h3>${sub.name}</h3><table class="output-table"><tr>`;
   grades.forEach(g=>html+=`<th>${gradeLabels[g]}</th>`);
   html+=`</tr><tr>`;

   grades.forEach(g=>{
     const r=calculateRequiredMarks(internal,g,sub.isHalf);
     const cls=r===-1?"not-possible":(r<= (sub.isHalf?50:100) ?"realistic":"possible");
     html+=`<td class="${cls}">${r===-1?"-":r.toFixed(1)}</td>`;
   });
   html+=`</tr></table>`;

   // corrected default grade logic
   let def=0;
   for(let g of grades){
     const lower={10:90,9:80,8:70,7:60,6:50,5:40}[g];
     const r=calculateRequiredMarks(internal,g,sub.isHalf);
     if(internal>=lower){ def=g; break; }
     if(r!==-1){ def=g; break; }
   }
   selectedGrades[sub.name]=def;

   html+=`<p><strong>Select Expected Grade:</strong><br>`;
   grades.forEach(g=>{
     html+=`
      <label>
       <input type="radio" name="g${i}" ${g===def?"checked":""}
       onchange="updateSelectedGrade('${sub.name}',${g})">
       ${gradeLabels[g]}
      </label>`;
   });
   html+=`</p>`;
 });

 document.getElementById("result").innerHTML=html;
 updateSGPA();
}

function updateSelectedGrade(sub,g){
 selectedGrades[sub]=g;
 updateSGPA();
}

function updateSGPA(){
 let tc=0,tp=0;
 subjects.forEach(s=>{
   if(selectedGrades[s.name]!=undefined){
     tc+=s.credits;
     tp+=selectedGrades[s.name]*s.credits;
   }
 });
 const sgpa=(tp/tc).toFixed(2);
 document.getElementById("result")
 .insertAdjacentHTML("beforeend",`<h2>ðŸŽ¯ SGPA: ${sgpa}</h2>`);
 saveResult(sgpa);
}

/* ===== SAVE ===== */
function saveResult(sgpa){
 fetch("https://sgpa-backend-m676.onrender.com/save-history",{
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({ name, usn, semester, result:sgpa, grades:selectedGrades })
 });
}

function clearInputs(){
 subjects.forEach((_,i)=>document.getElementById(`sub${i}`).value="");
 document.getElementById("result").innerHTML="";
}

function logout(){
 sessionStorage.clear();
 window.location.href="index.html";
}
</script>
</body>
</html>
