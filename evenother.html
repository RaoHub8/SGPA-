<!DOCTYPE html>
<html>
<head>
<title>Even Semester SGPA</title>
<link rel="stylesheet" href="predictor.css">
</head>
<body>

<div class="page">
<div class="top-bar">
<h1>Even Semester SGPA Predictor</h1>
<button onclick="logout()">Logout</button>
</div>

<div class="info" id="userInfo"></div>
<div id="form" class="card"></div>

<div class="action-bar">
<button onclick="predictGrades()">Get Result</button>
<button onclick="clearInputs()">Clear</button>
</div>

<div id="result" class="card"></div>

<div id="warning" style="display:none;text-align:center;">
<img src="idiot_warning.png" style="max-width:90%;border-radius:10px;">
</div>
</div>

<script>
const name=sessionStorage.getItem("name");
const usn=sessionStorage.getItem("usn");
const semester=sessionStorage.getItem("semester");
if(!name || !["2","4","6"].includes(semester)) location.href="index.html";
document.getElementById("userInfo").innerText=`ðŸ‘¤ ${name} (${usn}) | Sem ${semester}`;

/* ===== GENERIC CREDIT PATTERN EVEN ===== */
const semesterCredits={
"2":[4,4,3,3,1,1,1,1,2],
"4":[4,3,3,3,3,1,1,1],
"6":[4,4,3,3,3,3,1,1]
};

const subjects=semesterCredits[semester].map((c,i)=>({
 name:`${c} Credit Subject ${i+1}`,
 credits:c,
 isHalf:(c<=2)
}));

/* ===== COMMON LOGIC ===== */
const grades=[10,9,8,7,6,5,0];
const gradeLabels={10:"O",9:"A+",8:"A",7:"B+",6:"B",5:"C",0:"F"};

const form=document.getElementById("form");
subjects.forEach((s,i)=>{
 form.innerHTML+=`
 <div class="subject-group">
 <label>${s.name} :</label>
 <input type="text" id="sub${i}">
 </div>`;
});

function calculateRequiredMarks(internal,grade,isHalf){
 const lower={10:90,9:80,8:70,7:60,6:50,5:40}[grade];
 if(!lower) return -1;
 const req=isHalf?(lower-internal):2*(lower-internal);
 const max=isHalf?50:100;
 return (req<0||req>max)?-1:req;
}

function predictGrades(){
 document.getElementById("result").innerHTML="";
 document.getElementById("warning").style.display="none";

 for(let i=0;i<subjects.length;i++){
  const raw=document.getElementById(`sub${i}`).value.trim();
  if(raw==="") continue;
  if(!/^\d+$/.test(raw)) return showWarning();
  const v=parseInt(raw);
  if(v<0||v>50) return showWarning();
 }

 let html="";
 let tc=0,tp=0;

 subjects.forEach((sub,i)=>{
  const internal=parseInt(document.getElementById(`sub${i}`).value);
  if(isNaN(internal)) return;

  html+=`<h3>${sub.name}</h3><table class="output-table"><tr>`;
  grades.forEach(g=>html+=`<th>${gradeLabels[g]}</th>`);
  html+=`</tr><tr>`;

  let bestGrade=0;
  grades.forEach(g=>{
   const r=calculateRequiredMarks(internal,g,sub.isHalf);
   const cls=r==-1?"not-possible":(r<=(sub.isHalf?45:86)?"realistic":"possible");
   html+=`<td class="${cls}">${r==-1?"-":r}</td>`;
   if(bestGrade===0 && r!==-1 && r<=(sub.isHalf?45:86)) bestGrade=g;
  });

  html+=`</tr></table>`;
  tc+=sub.credits;
  tp+=bestGrade*sub.credits;
 });

 const sgpa=(tp/tc).toFixed(2);
 document.getElementById("result").innerHTML=html+`<h2>ðŸŽ¯ SGPA: ${sgpa}</h2>`;
 saveResult(sgpa);
}

function showWarning(){
 document.getElementById("warning").style.display="block";
}

function saveResult(sgpa){
 fetch("https://sgpa-backend-m676.onrender.com/save-history",{
 method:"POST",
 headers:{"Content-Type":"application/json"},
 body:JSON.stringify({name,usn,semester,result:sgpa})
 });
}

function clearInputs(){location.reload();}
function logout(){sessionStorage.clear();location.href="index.html";}
</script>
</body>
</html>
