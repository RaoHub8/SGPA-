<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Even Semester SGPA Predictor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="predictor.css">
</head>
<body>

<div class="page">

  <div class="top-bar">
    <h1>Even Semester SGPA Predictor</h1>
    <button onclick="logout()">Logout</button>
  </div>

  <div class="info" id="userInfo"></div>
  <div id="form" class="card"></div>

  <div class="action-bar">
    <button onclick="predictGrades()">Get Result</button>
    <button onclick="clearInputs()">Clear</button>
  </div>

  <div id="result" class="card"></div>

</div>
<div id="warning" style="display:none; text-align:center; margin-top:20px;">
  <img src="idiot_warning.png" style="max-width:90%; border-radius:12px;">
</div>

<script>
const name=sessionStorage.getItem("name");
const semester=sessionStorage.getItem("semester");

if(!name || !["4","6"].includes(semester)){
 window.location.href="index.html";
}

document.getElementById("userInfo").innerText=
`ðŸ‘¤ ${name} | Semester: ${semester}`;

/* ===== CREDIT + isHalf PATTERN ===== */

const semesterPattern={
 "4":[4,3,3,3,3,1,1,1],
 "6":[4,4,3,3,3,3,1,1]
};

const isHalfRule={
 "4":[false,false,false,false,false,true,true,true],
 "6":[false,true,false,false,false,false,true,true]
};

/* ===== COMMON SUBJECT NAMES ===== */

const commonNames={
 "4":["4 Credit Subject","Mathematics","3 Credit Subject 3","3 Credit Subject 4","3 Credit Subject 5","AEC","1 Credit Lab 1","1 Credit Lab 2"],
 "6":["4 Credit Subject","Mini Project","3 Credit Subject 3","3 Credit Subject 4","3 Credit Subject 5","Open Elective","1 Credit Lab 1","1 Credit Lab 2"]
};

const subjects=semesterPattern[semester].map((c,i)=>({
 name: commonNames[semester][i],
 credits:c,
 isHalf:isHalfRule[semester][i]
}));

/* ===== GRADING ===== */

const grades=[10,9,8,7,6,5,0];
const gradeLabels={10:"O",9:"A+",8:"A",7:"B+",6:"B",5:"C",0:"F"};
const selectedGrades={};

/* ===== BUILD FORM ===== */

const form=document.getElementById("form");
subjects.forEach((sub,i)=>{
 const div=document.createElement("div");
 div.className="subject-group";
 div.innerHTML=`
  <label>${sub.name} (${sub.credits} Credits) â€“ Internal Marks:</label>
  <input type="text" id="sub${i}" inputmode="numeric" pattern="[0-9]*">
 `;
 form.appendChild(div);
});

/* ===== CORE LOGIC ===== */

function calculateRequiredMarks(internal,grade,isHalf){
 const lower={10:90,9:80,8:70,7:60,6:50,5:40}[grade];
 if(!lower) return -1;
 const req=isHalf?(lower-internal):2*(lower-internal);
 const max=isHalf?50:100;
 return (req<0||req>max)?-1:req;
}

function predictGrades() {
  document.getElementById("result").innerHTML = "";
  Object.keys(selectedGrades).forEach(k => delete selectedGrades[k]);

  // Hide warning first
  document.getElementById("warning").style.display = "none";

  // Validation check
  for (let i = 0; i < subjects.length; i++) {
    const valRaw = document.getElementById(`sub${i}`).value.trim();

    if (valRaw === "") continue;

    if (!/^\d+(\.\d+)?$/.test(valRaw)) {
      document.getElementById("warning").style.display = "block";
      return;
    }

    const val = parseFloat(valRaw);

    if (val < 0 || val > 50) {
      document.getElementById("warning").style.display = "block";
      return;
    }
  }

  // âœ… INITIALIZE html
  let html = "";

  subjects.forEach((sub,i)=>{
    const internal=parseFloat(document.getElementById(`sub${i}`).value);
    if(isNaN(internal)) return;

    html+=`<h3>${sub.name}</h3><table class="output-table"><tr>`;
    grades.forEach(g=>html+=`<th>${gradeLabels[g]}</th>`);
    html+=`</tr><tr>`;

    grades.forEach(g=>{
      const r=calculateRequiredMarks(internal,g,sub.isHalf);
      const cls=r===-1?"not-possible":(r<=(sub.isHalf?45:86)?"realistic":"possible");
      html+=`<td class="${cls}">${r===-1?"-":r.toFixed(1)}</td>`;
    });

    html+=`</tr></table>`;

    let def=0;
    for(let g of grades){
      const r=calculateRequiredMarks(internal,g,sub.isHalf);
      if(r!==-1 && r<=(sub.isHalf?45:86)){def=g;break;}
    }
    selectedGrades[sub.name]=def;

    html+=`<p><strong>Select Expected Grade:</strong><br>`;
    grades.forEach(g=>{
      html+=`
        <label>
          <input type="radio" name="g${i}" ${g===def?"checked":""}
          onchange="updateSelectedGrade('${sub.name}',${g})">
          ${gradeLabels[g]}
        </label>`;
    });
    html+=`</p>`;
  });

  document.getElementById("result").innerHTML = html;
  updateSGPA();
}

function updateSelectedGrade(sub,g){
 selectedGrades[sub]=g;
 updateSGPA();
}

function updateSGPA(){
 let tc=0,tp=0;
 subjects.forEach(s=>{
  if(selectedGrades[s.name]!=undefined){
    tc+=s.credits;
    tp+=selectedGrades[s.name]*s.credits;
  }
 });
 const sgpa=(tp/tc).toFixed(2);
 document.getElementById("result").insertAdjacentHTML("beforeend",`<h2>ðŸŽ¯ SGPA: ${sgpa}</h2>`);
 saveResult(sgpa);
}

/* ===== SAVE ===== */
function saveResult(sgpa){
 fetch("https://sgpa-backend-m676.onrender.com/save-history",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({name,semester,result:sgpa,grades:selectedGrades})
 });
}

function clearInputs(){
 subjects.forEach((_,i)=>document.getElementById(`sub${i}`).value="");
 document.getElementById("result").innerHTML="";
}

function logout(){
 sessionStorage.clear();
 window.location.href="index.html";
}
</script>
</body>
</html>
