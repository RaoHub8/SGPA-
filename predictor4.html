<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>4th Sem SGPA Predictor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="predictor4.css">
</head>
<body>

<div class="top-bar">
  <h1>4th Sem SGPA Predictor</h1>
  <button onclick="logout()">Logout</button>
</div>

<p class="info" id="userInfo"></p>

<div id="form"></div>
<button onclick="calculateSGPA()">Predict SGPA</button>
<button onclick="clearInputs()">Clear Data</button>
<button onclick="viewHistory()">ðŸ“œ View History</button>
<button onclick="clearHistory()">ðŸ§¹ Clear History</button>
<div id="result"></div>
<div id="history"></div>

<script>
  window.addEventListener("load", () => {
    const name = localStorage.getItem("name");
    const semester = localStorage.getItem("semester");
    if (!name || semester !== "4") logout();
    document.getElementById("userInfo").innerText = `ðŸ‘¤ ${name} | Semester: ${semester}`;
  });

  function logout() {
    localStorage.clear();
    alert("You have been logged out.");
    window.location.href = "index.html";
  }

  const subjects = [
    { name: "Control Systems", credits: 4, isHalf: false },
    { name: "Biomedical Signal Processing", credits: 3, isHalf: false },
    { name: "RTES", credits: 3, isHalf: false },
    { name: "LIC", credits: 3, isHalf: false },
    { name: "Maths", credits: 3, isHalf: false },
    { name: "AEC â€“ Telemedicine", credits: 1, isHalf: true },
    { name: "BSP Lab", credits: 1, isHalf: true },
    { name: "LIC Lab", credits: 1, isHalf: true },
    { name: "RTES Lab", credits: 1, isHalf: true },
  ];

  const grades = [10, 9, 8, 7, 6, 5, 0];
  const gradeLabels = {10: "O", 9: "A+", 8: "A", 7: "B+", 6: "B", 5: "C", 0: "F"};

  function createForm() {
    const form = document.getElementById("form");
    subjects.forEach((sub, i) => {
      const group = document.createElement("div");
      group.className = "subject-group";
      group.innerHTML = `
        <label for="sub${i}">${sub.name} (Internal Marks):</label>
        <input type="number" id="sub${i}" min="0" max="50">
      `;
      form.appendChild(group);
    });
  }

  function calculateRequiredMarks(internal, grade, isHalf) {
    let lowerBound;
    switch (grade) {
      case 10: lowerBound = 90; break;
      case 9: lowerBound = 80; break;
      case 8: lowerBound = 70; break;
      case 7: lowerBound = 60; break;
      case 6: lowerBound = 50; break;
      case 5: lowerBound = 40; break;
      default: return -1;
    }
    const required = isHalf ? (lowerBound - internal) : 2 * (lowerBound - internal);
    const maxLimit = isHalf ? 50 : 100;
    return required > maxLimit || required < 0 ? -1 : required;
  }

  function calculateSGPA() {
    let totalCredits = 0;
    let totalPoints = 0;
    let html = "";

    subjects.forEach((sub, i) => {
      const input = document.getElementById(`sub${i}`).value;
      const internal = parseFloat(input);
      if (isNaN(internal)) return;

      html += `<h3>${sub.name}</h3>`;
      html += `<table class='output-table'><tr>`;
      grades.forEach(g => html += `<th>${gradeLabels[g]}<br>(${g})</th>`);
      html += `</tr><tr>`;

      let realisticGrade = 0;
      grades.forEach(grade => {
        const req = calculateRequiredMarks(internal, grade, sub.isHalf);
        let className = "not-possible";
        let cell = "-";
        if (req !== -1) {
          className = "possible";
          cell = req.toFixed(2);
          if (realisticGrade === 0 && ((sub.isHalf && req <= 45) || (!sub.isHalf && req <= 90))) {
            realisticGrade = grade;
            className = "realistic";
          }
        }
        html += `<td class='${className}'>${cell}</td>`;
      });

      html += `</tr></table>`;
      html += `<p><strong>âœ” Probable Grade Chosen:</strong> ${gradeLabels[realisticGrade]} (${realisticGrade})</p>`;
      totalPoints += realisticGrade * sub.credits;
      totalCredits += sub.credits;
    });

    const sgpa = (totalPoints / totalCredits).toFixed(2);
    html += `<h2>ðŸŽ¯ Predicted SGPA: ${sgpa}</h2>`;
    document.getElementById("result").innerHTML = html;

    const name = localStorage.getItem("name");
    const semester = localStorage.getItem("semester");
    if (name && semester) {
      fetch("https://sgpa-backend-m676.onrender.com/save-history", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ name, semester, result: sgpa })
      });
    }
  }

  function clearInputs() {
    subjects.forEach((_, i) => document.getElementById(`sub${i}`).value = "");
    document.getElementById("result").innerHTML = "";
  }

  function viewHistory() {
    const name = localStorage.getItem("name");
    if (!name) return alert("Please login again.");
    fetch(`https://sgpa-backend-m676.onrender.com/history/${name}`)
      .then(res => res.json())
      .then(data => {
        if (!data.history || data.history.length === 0) {
          document.getElementById("history").innerHTML = "<p>No history found.</p>";
          return;
        }
        let html = "<h3>Your SGPA History:</h3><ul style='list-style:none;padding:0'>";
        data.history.forEach(entry => {
          const date = new Date(entry.date).toLocaleString();
          html += `<li>ðŸ“… ${date} â€” SGPA: <strong>${entry.result}</strong></li>`;
        });
        html += "</ul>";
        document.getElementById("history").innerHTML = html;
      })
      .catch(err => {
        console.error("History error:", err);
        document.getElementById("history").innerHTML = "<p>Error loading history.</p>";
      });
  }

  function clearHistory() {
    const name = localStorage.getItem("name");
    if (!name) return alert("Please login again.");
    if (!confirm("Clear all your SGPA prediction history?")) return;
    fetch(`https://sgpa-backend-m676.onrender.com/history/${name}`, {
      method: "DELETE"
    })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "History cleared.");
        document.getElementById("history").innerHTML = "";
      })
      .catch(err => {
        console.error("Clear error:", err);
        alert("Could not clear history.");
      });
  }

  createForm();
</script>
</body>
</html>
