<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>2nd Sem SGPA Predictor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="predictor4.css">
</head>
<body>
  <div class="top-bar">
    <h1>2nd Sem SGPA Predictor</h1>
    <button onclick="logout()">Logout</button>
  </div>

  <p class="info" id="userInfo"></p>

  <div id="form"></div>
  <button onclick="calculateSGPA()">Predict SGPA</button>
  <button onclick="clearInputs()">Clear Data</button>
  <button onclick="viewHistory()">ðŸ“œ View History</button>
  <button onclick="clearHistory()">ðŸ§¹ Clear History</button>

  <div id="result"></div>
  <div id="history"></div>

  <script>
    const subjects = [
      { name: "Mathematics", credits: 4, isHalf: false },
      { name: "Physics", credits: 3, isHalf: false },
      { name: "English", credits: 1, isHalf: true },
      { name: "Kannada", credits: 1, isHalf: true },
      { name: "Health", credits: 1, isHalf: true },
      { name: "Basic Electronics", credits: 3, isHalf: false },
      { name: "Intro to Electrical Engg (ESC)", credits: 3, isHalf: false },
      { name: "Intro to Web Dev (PLC)", credits: 3, isHalf: false },
      { name: "Physics Lab", credits: 1, isHalf: true }
    ];

    const grades = [10, 9, 8, 7, 6, 5, 0];
    const gradeLabels = {10: "O", 9: "A+", 8: "A", 7: "B+", 6: "B", 5: "C", 0: "F"};

    let selectedGrades = Array(subjects.length).fill(0);

    window.addEventListener("load", () => {
      const name = localStorage.getItem("name");
      const semester = localStorage.getItem("semester");
      if (!name || semester !== "2") logout();
      document.getElementById("userInfo").innerText = `ðŸ‘¤ ${name} | Semester: ${semester}`;
      createForm();
    });

    function logout() {
      localStorage.clear();
      alert("Logged out.");
      window.location.href = "index.html";
    }

    function createForm() {
      const form = document.getElementById("form");
      form.innerHTML = '';
      subjects.forEach((sub, i) => {
        const group = document.createElement("div");
        group.className = "subject-group";
        group.innerHTML = `
          <label for="sub${i}">${sub.name} (Internal Marks):</label>
          <input type="number" id="sub${i}" min="0" max="50">
        `;
        form.appendChild(group);
      });
    }

    function calculateRequiredMarks(internal, grade, isHalf) {
      let lowerBound;
      switch (grade) {
        case 10: lowerBound = 90; break;
        case 9: lowerBound = 80; break;
        case 8: lowerBound = 70; break;
        case 7: lowerBound = 60; break;
        case 6: lowerBound = 50; break;
        case 5: lowerBound = 40; break;
        default: return -1;
      }
      const required = isHalf ? (lowerBound - internal) : 2 * (lowerBound - internal);
      const maxLimit = isHalf ? 50 : 100;
      return required > maxLimit || required < 0 ? -1 : required;
    }

    function calculateSGPA() {
      let html = "";
      let totalPoints = 0;
      let totalCredits = 0;

      subjects.forEach((sub, i) => {
        const input = parseFloat(document.getElementById(`sub${i}`).value);
        if (isNaN(input)) return;

        html += `<h3>${sub.name}</h3><table class="output-table"><tr>`;
        grades.forEach(g => html += `<th>${gradeLabels[g]}<br>(${g})</th>`);
        html += "</tr><tr>";

        let realisticGrade = 0;
        grades.forEach(g => {
          const req = calculateRequiredMarks(input, g, sub.isHalf);
          let className = "not-possible";
          let cell = "-";
          if (req !== -1) {
            className = "possible";
            cell = req.toFixed(2);
            if (realisticGrade === 0 && ((sub.isHalf && req <= 45) || (!sub.isHalf && req <= 90))) {
              realisticGrade = g;
              className = "realistic";
            }
          }
          html += `<td class="${className}">${cell}</td>`;
        });

        html += "</tr><tr><td colspan='7'>Select Grade: ";
        grades.forEach(g => {
          const checked = (selectedGrades[i] === g || (selectedGrades[i] === 0 && g === realisticGrade)) ? "checked" : "";
          html += `<label><input type="radio" name="grade${i}" value="${g}" ${checked} onclick="updateGrade(${i}, ${g})"> ${gradeLabels[g]}</label> `;
        });
        html += "</td></tr></table>";

        const finalGrade = selectedGrades[i] || realisticGrade;
        totalPoints += finalGrade * sub.credits;
        totalCredits += sub.credits;
      });

      const sgpa = (totalPoints / totalCredits).toFixed(2);
      html += `<h2>ðŸŽ¯ Predicted SGPA: ${sgpa}</h2>`;
      document.getElementById("result").innerHTML = html;

      const name = localStorage.getItem("name");
      const semester = localStorage.getItem("semester");
      if (name && semester) {
        fetch("https://sgpa-backend-m676.onrender.com/save-history", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ name, semester, result: sgpa })
        });
      }
    }

    function updateGrade(index, grade) {
      selectedGrades[index] = grade;
      calculateSGPA();
    }

    function clearInputs() {
      subjects.forEach((_, i) => {
        document.getElementById(`sub${i}`).value = "";
        selectedGrades[i] = 0;
      });
      document.getElementById("result").innerHTML = "";
    }

    function viewHistory() {
      const name = localStorage.getItem("name");
      fetch(`https://sgpa-backend-m676.onrender.com/history/${name}`)
        .then(res => res.json())
        .then(data => {
          if (!data.history) return;
          const historyHtml = data.history.map(h =>
            `<p>ðŸ“… ${new Date(h.date).toLocaleString()} â€” SGPA: ${h.result}</p>`
          ).join("");
          document.getElementById("history").innerHTML = `<h3>ðŸ“œ Your History:</h3>` + historyHtml;
        });
    }

    function clearHistory() {
      const name = localStorage.getItem("name");
      fetch("https://sgpa-backend-m676.onrender.com/clear-history", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ name })
      }).then(() => {
        document.getElementById("history").innerHTML = "";
        alert("History cleared.");
      });
    }
  </script>
</body>
</html>
